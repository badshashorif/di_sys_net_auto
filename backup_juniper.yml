---
# BACKUP HUAWEI SWITCHES - Optimized Playbook

- name: Collect date and create backup directory
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Collect today's date
      set_fact:
        DTG: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"

    - name: Pass DTG to all hosts
      add_host:
        name: "{{ item }}"
        groups: HUAWEI_SW
        DTG: "{{ DTG }}"
      with_items: "{{ groups['HUAWEI_SW'] }}"

    - name: Create directory for backups
      file:
        path: "/root/network/backups/HUAWEI/bkp_{{ DTG }}/Switches/"
        state: directory
  run_once: true

- name: Backup Huawei configuration via CLI
  hosts: HUAWEI_SW
  gather_facts: false
  tasks:
    - name: Execute display configuration command
      ansible.netcommon.cli_command:
        commands:
          - display current-configuration
      register: config_output

    - name: Save configuration to file
      copy:
        content: "{{ config_output.stdout }}"
        dest: "/root/network/backups/HUAWEI/bkp_{{ hostvars['localhost']['DTG'] }}/Switches/{{ inventory_hostname }}.cfg"
