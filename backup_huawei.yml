---
- name: Backup Huawei Switch Configurations
  hosts: HUAWEI_SW
  gather_facts: no
  vars:
    backup_directory: "{{ backup_directory | default('/root/network/backups/HUAWEI') }}"
  tasks:
    - name: Ensure the backup directory exists
      ansible.builtin.file:
        path: "{{ backup_directory }}"
        state: directory
        mode: '0755'

    - name: Fetch configuration from Huawei switches
      ansible.netcommon.cli_command:
        command: display current-configuration
        timeout: 60
        register: config_output

    - name: Parse sysname from configuration
      set_fact:
        sysname: "{{ (config_output.stdout | regex_search('sysname\\s+(\\S+)')).group(1) | default('unknown_' + inventory_hostname) }}"

    - name: Save configuration to backup file
      copy:
        content: "{{ config_output.stdout }}"
        dest: "{{ backup_directory }}/{{ sysname }}_{{ ansible_date_time.iso8601_basic }}.txt"

    - name: Display success message
      debug:
        msg: "Backup successful for {{ sysname }}. Saved to {{ backup_directory }}/{{ sysname }}_{{ ansible_date_time.iso8601_basic }}.txt"
