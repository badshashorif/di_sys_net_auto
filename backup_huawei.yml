---
# BACKUP HUAWEI SWITCHES - Optimized Playbook
# This playbook creates a directory for backups and saves Huawei switch configurations.

# Task to create a directory for backups
- name: Collect date and create backup directory
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Collect today's date
      set_fact:
        DTG: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"

    - name: Pass DTG to all hosts
      add_host:
        name: "{{ item }}"
        groups: HUAWEI_SW
        DTG: "{{ DTG }}"
      with_items: "{{ groups['HUAWEI_SW'] }}"

    - name: Create directory for backups
      file:
        path: "/root/network/backups/HUAWEI/bkp_{{ DTG }}/Switches/"
        state: directory
  run_once: true

# Task to back up Huawei switch configurations
- name: Backup Huawei switch configuration
  hosts: HUAWEI_SW
  gather_facts: false
  tasks:
    - name: Ensure screen-length is set to 0
      ansible.netcommon.cli_command:
        commands:
          - system-view
          - screen-width 60
      register: cli_output

    - name: Copy the configuration file of each Huawei switch to a .cfg file
      ce_config:
        backup: yes
        backup_options:
          filename: "{{ inventory_hostname }}.cfg"
          dir_path: "/root/network/backups/HUAWEI/bkp_{{ hostvars['localhost']['DTG'] }}/Switches/"

# Additional steps for environments requiring password authentication
- name: Ensure sshpass for password-based SSH
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check if sshpass is installed
      ansible.builtin.shell: whereis sshpass | awk '{print $2}'
      register: sshpass_check
      delegate_to: localhost
      run_once: true

    - name: Fail if sshpass is not installed
      ansible.builtin.fail:
        msg: >-
          sshpass is required for password-based authentication. Please install sshpass
          and re-run the playbook. See details at https://www.redhat.com/sysadmin/ssh-automation-sshpass
      when: sshpass_check.stdout | length == 0
